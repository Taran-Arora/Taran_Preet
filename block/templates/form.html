<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Send Tokens</title>
  <link rel="stylesheet" href="/css/form.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
</head>

<body>
  <div class="main-form">
    <form id="token-form">
      <div class="form">
        <div class="heading">
          <h1>Send Tokens</h1>
        </div>
        <div class="select-option">
          <select class="select-op" name="token" id="token">
            <option value="">Select option</option>
            <option value="BNB">BNB</option>
            <option value="USDT">USDT</option>
            <option value="TRC">TRC</option>
          </select>
        </div>
        <input class="account-field" type="text" id="account" placeholder="Account Address" />
        <input class="amount-field" type="text" id="amount" placeholder="Amount" />
        <div class="send-token">
          <button type="submit">Send Tokens</button>
        </div>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    const usdtContractAddress = '0x55d398326f99059fF775485246999027B3197955'; // USDT contract address on BSC
    const usdtABI = [
      // Add the relevant parts of the USDT ABI here
      {
        "constant": true,
        "inputs": [],
        "name": "name",
        "outputs": [
          {
            "name": "",
            "type": "string"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          {
            "name": "_to",
            "type": "address"
          },
          {
            "name": "_value",
            "type": "uint256"
          }
        ],
        "name": "transfer",
        "outputs": [
          {
            "name": "",
            "type": "bool"
          }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    async function sendTransaction(token, receiverAccount, amount) {
      if (typeof window.ethereum !== 'undefined') {
        const web3 = new Web3(window.ethereum);
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const accounts = await web3.eth.getAccounts();
          const senderAccount = accounts[0];
          if (token === 'USDT') {
            const usdtContract = new web3.eth.Contract(usdtABI, usdtContractAddress);
            const amountInWei = web3.utils.toWei(amount); // USDT has 6 decimal places
            usdtContract.methods.transfer(receiverAccount, amountInWei).send({ from: senderAccount })
              .on('transactionHash', function (hash) {
                console.log('Transaction initiated. TxHash:', hash);
              })

              .on('receipt', function (receipt) {
                const toast = Toastify({
                  text: 'Transaction successful! TxHash: ' + receipt.transactionHash,
                  duration: 3000,
                  close: true,
                  gravity: 'bottom',
                  position: 'right',
                  backgroundColor: 'linear-gradient(to right, #00b09b, #96c93d)',
                  className: 'info',
                });
                toast.showToast();

                // Send transaction details to API
                const transactionData = {
                  senderAddress: senderAccount,
                  receiverAccount: receiverAccount,
                  amount: amount,
                  hash: receipt.transactionHash,
                  token: token
                };

                fetch('/api/home', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(transactionData),
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json();
                  })
                  .then(data => {
                    console.log('Transaction details sent to API:', data);
                  })
                  .catch(error => {
                    console.error('Error sending transaction details to API:', error);
                  });
              })

              .on('error', function (error) {
                Toastify({
                  text: 'Transaction failed: ' + error.message,
                  duration: 3000, // Display duration in milliseconds
                  close: true,
                  gravity: 'bottom', // Add 'top' or 'bottom' to change gravity
                  position: 'right', // 'left' or 'right'
                  backgroundColor: 'linear-gradient(to right, #ff416c, #ff4b2b)',
                  className: 'error',
                }).showToast();
                console.error('Error:', error);
              });
          }
          // Add BNB and TRC transactions if needed with respective RPC calls
        } catch (error) {
          console.error('User denied transaction:', error);
        }
      } else {
        alert('MetaMask is not installed!');
      }
    }

    document.getElementById('token-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const token = document.getElementById('token').value;
      const receiverAccount = document.getElementById('account').value;
      const amount = document.getElementById('amount').value;

      if (!token || !receiverAccount || !amount) {
        Toastify({
          text: 'Please fill in all fields',
          duration: 3000,
          close: true,
          gravity: 'bottom',
          position: 'right',
          backgroundColor: 'linear-gradient(to right, #ffae00, #ff416c)',
          className: 'warning',
        }).showToast();
        return;
      }

      sendTransaction(token, receiverAccount, amount);
    });
  </script>
</body>

</html>